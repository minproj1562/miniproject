{% extends "base.html" %}
{% block title %}Enhanced Resume Builder{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/resume.css') }}">
{% endblock %}

{% block content %}
<div class="resume-builder">
    <div class="builder-form">
        <form id="resumeForm" method="POST" action="{{ url_for('resume_builder') }}" enctype="multipart/form-data">
            <div class="builder-section">
                <h2>Choose a Template</h2>
                <select name="template" id="templateSelect" class="form-control" onchange="updateTemplatePreview()">
                    <option value="modern" {% if resume.get('template', 'modern') == 'modern' %}selected{% endif %}>Modern</option>
                    <option value="classic" {% if resume.get('template', 'classic') == 'classic' %}selected{% endif %}>Classic</option>
                    <option value="creative" {% if resume.get('template', 'creative') == 'creative' %}selected{% endif %}>Creative</option>
                </select>
                <input type="hidden" name="current_template" id="currentTemplate" value="{{ resume.get('template', 'modern') }}">
            </div>

            <div class="builder-section">
                <h2>Profile Photo</h2>
                <input type="file" name="photo" accept="image/*" class="form-control" onchange="updatePreview()">
                <small>Upload a professional photo (optional).</small>
            </div>

            <div class="builder-section">
                <h2>Personal Information</h2>
                <input type="text" class="form-control" name="name" value="{{ resume.get('personal_info', {}).get('name', '') }}" placeholder="Full Name" required onchange="updatePreview()">
                <input type="email" class="form-control" name="email" value="{{ resume.get('personal_info', {}).get('email', '') }}" placeholder="Email" required onchange="updatePreview()">
                <input type="tel" class="form-control" name="phone" value="{{ resume.get('personal_info', {}).get('phone', '') }}" placeholder="Phone Number" onchange="updatePreview()">
                <input type="url" class="form-control" name="linkedin" value="{{ resume.get('personal_info', {}).get('linkedin', '') }}" placeholder="LinkedIn Profile" onchange="updatePreview()">
                <small>Use a professional email and ensure your LinkedIn is up-to-date.</small>
            </div>

            <div class="builder-section" id="educationSection">
                <h2>Education</h2>
                <div id="educationFields">
                    {% for edu in resume.get('education', []) %}
                    <div class="dynamic-section mt-2">
                        <input type="text" class="form-control" name="education[]" value="{{ edu.get('degree', '') }}" placeholder="Degree" required onchange="updatePreview()">
                        <input type="text" class="form-control" name="institution[]" value="{{ edu.get('institution', '') }}" placeholder="Institution" required onchange="updatePreview()">
                        <input type="month" class="form-control" name="education_date[]" value="{{ edu.get('date', '') }}" onchange="updatePreview()">
                        <button type="button" class="btn btn-sm btn-danger mt-2" onclick="this.parentElement.remove(); updatePreview()">Remove</button>
                    </div>
                    {% endfor %}
                    {% if not resume.get('education', []) %}
                    <div class="dynamic-section">
                        <input type="text" class="form-control" name="education[]" placeholder="Degree" required onchange="updatePreview()">
                        <input type="text" class="form-control" name="institution[]" placeholder="Institution" required onchange="updatePreview()">
                        <input type="month" class="form-control" name="education_date[]" onchange="updatePreview()">
                    </div>
                    {% endif %}
                </div>
                <button type="button" class="btn-add" onclick="addEducation()">+ Add Education</button>
                <small>List your most recent education first; include certifications.</small>
            </div>

            <div class="builder-section" id="experienceSection">
                <h2>Work Experience</h2>
                <div id="experienceFields">
                    {% for exp in resume.get('experience', []) %}
                    <div class="dynamic-section mt-2">
                        <input type="text" class="form-control" name="position[]" value="{{ exp.get('position', '') }}" placeholder="Position" required onchange="updatePreview()">
                        <input type="text" class="form-control" name="company[]" value="{{ exp.get('company', '') }}" placeholder="Company" onchange="updatePreview()">
                        <textarea class="form-control" name="description[]" placeholder="Job Description" onchange="updatePreview()">{{ exp.get('description', '') }}</textarea>
                        <input type="month" class="form-control" name="experience_date[]" value="{{ exp.get('date', '') }}" onchange="updatePreview()">
                        <button type="button" class="btn btn-sm btn-danger mt-2" onclick="this.parentElement.remove(); updatePreview()">Remove</button>
                    </div>
                    {% endfor %}
                    {% if not resume.get('experience', []) %}
                    <div class="dynamic-section">
                        <input type="text" class="form-control" name="position[]" placeholder="Position" required onchange="updatePreview()">
                        <input type="text" class="form-control" name="company[]" placeholder="Company" onchange="updatePreview()">
                        <textarea class="form-control" name="description[]" placeholder="Job Description" onchange="updatePreview()"></textarea>
                        <input type="month" class="form-control" name="experience_date[]" onchange="updatePreview()">
                    </div>
                    {% endif %}
                </div>
                <button type="button" class="btn-add" onclick="addExperience()">+ Add Experience</button>
                <small>Use action verbs and quantify achievements (e.g., "Led a team of 5").</small>
            </div>

            <div class="builder-section" id="skillsSection">
                <h2>Skills</h2>
                <div id="skillsContainer" class="mb-3">
                    <div class="skill-input-group position-relative">
                        <input type="text" class="form-control skill-input" placeholder="Type skill and press Enter" id="skillInput">
                        <div id="suggestions" class="suggestions-dropdown"></div>
                    </div>
                    <div id="selectedSkills" class="mt-2">
                        {% for skill in resume.get('skills', []) %}
                        <span class="skill-tag">{{ skill }} <button type="button" onclick="removeSkill('{{ skill }}'); updatePreview()">Ã—</button></span>
                        {% endfor %}
                    </div>
                    <input type="hidden" name="skills" id="hiddenSkills" value="{{ resume.get('skills', [])|tojson|safe }}">
                </div>
                <small>Mix technical (e.g., "JavaScript") and soft skills (e.g., "Problem Solving").</small>
            </div>

            <div class="builder-section">
                <h2>Professional Summary</h2>
                <textarea class="form-control" name="summary" rows="4" placeholder="E.g., Detail-oriented developer with expertise in Python and team leadership." onchange="updatePreview()">{{ resume.get('summary', '') }}</textarea>
                <small>Keep it concise (2-3 sentences) and highlight key strengths.</small>
            </div>

            <button type="submit" class="btn-primary">Save Resume</button>
        </form>
    </div>

    <div class="preview-section">
        <div class="preview-content" id="resumePreview">
            <div class="photo-preview">
                {% if resume.get('photo', '') %}
                <img id="previewPhoto" src="{{ resume['photo'] }}" alt="Profile Photo">
                {% else %}
                <img id="previewPhoto" src="" alt="Profile Photo" style="display: none;">
                {% endif %}
            </div>
            <h1 id="previewName">{{ resume.get('personal_info', {}).get('name', 'Your Name') }}</h1>
            <div class="contact-info">
                <p id="previewEmail">Email: {{ resume.get('personal_info', {}).get('email', 'your.email@example.com') }}</p>
                <p id="previewPhone">Phone: {{ resume.get('personal_info', {}).get('phone', '(123) 456-7890') }}</p>
                <p id="previewLinkedIn">LinkedIn: {{ resume.get('personal_info', {}).get('linkedin', 'linkedin.com/in/yourprofile') }}</p>
            </div>
            <div class="summary-preview section">
                <h3>Professional Summary</h3>
                <p id="previewSummary">{{ resume.get('summary', 'Your professional summary will appear here.') }}</p>
            </div>
            <div class="education-preview section" id="previewEducation">
                <h3>Education</h3>
                {% for edu in resume.get('education', []) %}
                <div class="education-item">
                    <h4>{{ edu.get('degree', '') }}</h4>
                    <p>{{ edu.get('institution', '') }} - {{ edu.get('date', '') }}</p>
                </div>
                {% endfor %}
            </div>
            <div class="experience-preview section" id="previewExperience">
                <h3>Experience</h3>
                {% for exp in resume.get('experience', []) %}
                <div class="experience-item">
                    <h4>{{ exp.get('position', '') }}</h4>
                    <p>{{ exp.get('company', '') }} - {{ exp.get('date', '') }}</p>
                    <p>{{ exp.get('description', '') }}</p>
                </div>
                {% endfor %}
            </div>
            <div class="skills-preview section" id="previewSkills">
                <h3>Skills</h3>
                {% for skill in resume.get('skills', []) %}
                <span class="skill-tag">{{ skill }}</span>
                {% endfor %}
            </div>
        </div>
        <button class="btn-add" onclick="exportPDF()">Export as PDF</button>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/resume.js') }}"></script>
{% endblock %}