{% extends "base.html" %}

{% block title %}Dashboard - Career Analytics{% endblock %}

{% block styles %}
{{ super() }}
<style>
    /* Base Styles */
    body.dashboard-page {
        background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%) !important;
        color: #2c3e50;
        font-family: 'Poppins', sans-serif;
        min-height: 100vh;
        overflow-x: hidden;
        margin: 0;
        padding: 0;
    }
    
    body.dashboard-page.dark-mode {
        background: linear-gradient(135deg, #4b134f 0%, #1e3c72 100%) !important;
        color: #ecf0f1;
    }
    
    /* Container Styles */
    .container:not(.navbar .container) {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
    
    @supports (backdrop-filter: blur(10px)) {
        .container:not(.navbar .container) {
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
        }
    }
    
    /* Header Section */
    .dashboard-header-section {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 30px;
    }
    
    @media (max-width: 576px) {
        .dashboard-header-section {
            flex-direction: column;
            text-align: center;
        }
    }
    
    .dashboard-header {
        color: #e91e63;
        font-weight: 700;
        margin: 0;
    }
    
    /* User Avatar */
    .user-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: linear-gradient(45deg, #e9ecef, #d1d9e6);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        border: 3px solid #fff;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }
    
    .user-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    /* Profile Summary */
    .profile-summary {
        background: #ffffff;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        margin-bottom: 30px;
    }
    
    .profile-summary h5 {
        color: #ff6f61;
        font-weight: 600;
        margin-bottom: 20px;
    }
    
    .profile-summary .summary-item {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
        font-size: 1rem;
    }
    
    .profile-summary .bio {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
    }
    
    /* Buttons */
    .btn-edit-profile {
        background: linear-gradient(90deg, #1abc9c, #16a085);
        border: none;
        padding: 8px 20px;
        border-radius: 25px;
        color: white;
        font-weight: 600;
    }
    
    .btn-take-test {
        background: linear-gradient(90deg, #ff6f61, #ff3d2e);
        border: none;
        padding: 10px 25px;
        border-radius: 25px;
        color: white;
        font-weight: 600;
    }
    
    /* Cards */
    .card {
        border: none;
        border-radius: 15px;
        background: #ffffff;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        margin-bottom: 20px;
    }
    
    .card-header {
        background: linear-gradient(90deg, #ff6f61, #ff3d2e);
        color: white;
        border-radius: 15px 15px 0 0 !important;
        font-weight: 600;
    }
    
    /* Progress Elements */
    .progress-stat .progress {
        height: 25px;
        border-radius: 12px;
    }
    
    .progress-bar {
        background: linear-gradient(90deg, #1abc9c, #16a085);
    }
    
    /* Responsive Adjustments */
    @media (max-width: 768px) {
        .progress-stat .progress {
            width: 100% !important;
        }
        
        .dashboard-header {
            font-size: 1.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5 mb-5">
    <!-- Header Section -->
    <div class="dashboard-header-section">
        <a href="{{ url_for('profile') }}" class="user-avatar" aria-label="Go to profile">
            {% if user.profile_image and user.profile_image != 'images/default_profile.jpg' %}
                <img src="{{ url_for('static', filename=user.profile_image) }}" alt="Profile picture of {{ user.username }}">
            {% else %}
                <span class="fas fa-user" aria-hidden="true"></span>
            {% endif %}
        </a>
        <h1 class="dashboard-header" id="greeting">Welcome, {{ user.username }}!</h1>
    </div>

    <!-- Profile Summary -->
    <div class="profile-summary">
        <h5>Profile Summary</h5>
        <div class="summary-item">
            <span class="fas fa-user" aria-hidden="true"></span>
            <span><strong>Username:</strong> {{ user.username }}</span>
        </div>
        <div class="summary-item">
            <span class="fas fa-envelope" aria-hidden="true"></span>
            <span><strong>Email:</strong> {{ user.email }}</span>
        </div>
        <div class="summary-item">
            <span class="fas fa-file-alt" aria-hidden="true"></span>
            <span><strong>Total Tests Taken:</strong> {{ tests|length }}</span>
        </div>
        <div class="summary-item">
            <span class="fas fa-trophy" aria-hidden="true"></span>
            <span><strong>Badges Earned:</strong> {{ badges|length }}</span>
        </div>
        <div class="bio">
            <strong>Bio:</strong>
            {% if user.bio and user.bio.strip() %}
                <p>{{ user.bio | e }}</p>
            {% else %}
                <p class="text-muted">Tell us about yourself! Add a bio in your profile settings.</p>
            {% endif %}
        </div>
        <a href="{{ url_for('profile') }}" class="btn btn-edit-profile">Edit Profile</a>
    </div>

    <!-- Quick Links -->
    <div class="card mb-4">
        <div class="card-header">Quick Links</div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <a href="{{ url_for('career_match') }}" class="btn btn-outline-primary w-100">
                        <span class="fas fa-briefcase me-2" aria-hidden="true"></span> Career Matching
                    </a>
                </div>
                <div class="col-md-4 mb-3">
                    <a href="{{ url_for('test', type='aptitude') }}" class="btn btn-outline-primary w-100">
                        <span class="fas fa-brain me-2" aria-hidden="true"></span> Aptitude Test
                    </a>
                </div>
                <div class="col-md-4 mb-3">
                    <a href="{{ url_for('test', type='personality') }}" class="btn btn-outline-primary w-100">
                        <span class="fas fa-user me-2" aria-hidden="true"></span> Personality Test
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications -->
    {% if notifications %}
        <div class="card mb-4">
            <div class="card-header">Notifications</div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    {% for notification in notifications %}
                        <li class="list-group-item d-flex justify-content-between align-items-center" data-notification-id="{{ notification.id }}">
                            <span>{{ notification.message }}</span>
                            <button class="btn btn-sm btn-outline-secondary mark-read" data-id="{{ notification.id }}">
                                Mark as Read
                            </button>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    {% endif %}

    <!-- Main Content Row -->
    <div class="row">
        <!-- Recent Tests -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">Recent Tests</div>
                <div class="card-body">
                    {% if tests %}
                        <ul class="list-group list-group-flush">
                            {% for test in tests %}
                                <li class="list-group-item">
                                    <div>
                                        <strong>{{ test.test_type | capitalize }}</strong><br>
                                        <small>Score: {{ test.score|round(2) }}%</small><br>
                                        <small>Completed: {{ test.completed_at.strftime('%Y-%m-%d %H:%M') }}</small>
                                    </div>
                                    <span class="badge bg-{{ 'success' if test.score >= 80 else 'warning' }} rounded-pill">
                                        {{ 'Excellent' if test.score >= 80 else 'Good' }}
                                    </span>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>No tests taken yet. Start your journey now!</p>
                        <a href="{{ url_for('test', type='aptitude') }}" class="btn btn-take-test">Take a Test</a>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Badges -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">Your Badges</div>
                <div class="card-body">
                    {% if badges %}
                        <div class="row">
                            {% for badge in badges %}
                                <div class="col-6 mb-3">
                                    <div class="text-center">
                                        <span class="{{ badge.icon }} fa-2x mb-2" aria-hidden="true"></span>
                                        <h6>{{ badge.name }}</h6>
                                        <small class="text-muted">{{ badge.description }}</small>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p>No badges earned yet. Keep taking tests to earn some!</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Test Options -->
    <div class="card mb-4">
        <div class="card-header">Your Test Progress</div>
        <div class="card-body">
            <h5>Available Tests</h5>
            <div class="mb-3">
                {% if available_tests.aptitude %}
                    <a href="{{ url_for('test', type='aptitude') }}" class="btn btn-take-test me-2 mb-2">Take Aptitude Test</a>
                {% endif %}
                {% if available_tests.personality %}
                    <a href="{{ url_for('test', type='personality') }}" class="btn btn-take-test me-2 mb-2">Take Personality Test</a>
                {% endif %}
                {% if available_tests.skill_gap %}
                    <a href="{{ url_for('interest_test') }}" class="btn btn-take-test me-2 mb-2">Take Skill Gap Test</a>
                {% endif %}
            </div>
            {% if can_proceed %}
                <h5>Next Steps</h5>
                <a href="{{ url_for('career_match') }}" class="btn btn-take-test">Proceed to Career Matching</a>
            {% endif %}
        </div>
    </div>

    <!-- Progress Section -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header">Your Progress</div>
                <div class="card-body text-center">
                    <div class="progress-circle mx-auto mb-3">
                        <svg viewBox="0 0 100 100">
                            <circle class="bg" cx="50" cy="50" r="45"></circle>
                            <circle class="fg" cx="50" cy="50" r="45" 
                                    stroke-dasharray="283" 
                                   stroke-dashoffset="{{ 283 - (283 * ((tests|length * 33.33)|round|int) / 100) }}">
                            </circle>
                        </svg>
                        <span>{{ (tests|length * 33.33)|round|int }}%</span>
                    </div>
                    <p>Complete all 3 tests for full career analysis!</p>
                </div>
            </div>
        </div>
        <div class="col-md-8">
            <div class="card h-100">
                <div class="card-header">Recent Activity</div>
                <div class="card-body">
                    {% if tests or badges %}
                        <div class="list-group list-group-flush">
                            {% for test in tests[:3] %}
                                <div class="list-group-item">
                                    <div>
                                        <strong>Completed {{ test.test_type | capitalize }} test</strong>
                                        <p class="mb-1">Score: {{ test.score|round(2) }}%</p>
                                        <small class="text-muted">{{ test.completed_at.strftime('%Y-%m-%d %H:%M') }}</small>
                                    </div>
                                </div>
                            {% endfor %}
                            {% for badge in badges[:3] %}
                                <div class="list-group-item">
                                    <div>
                                        <strong>Earned {{ badge.name }} badge</strong>
                                        <small class="text-muted">{{ badge.date_earned.strftime('%Y-%m-%d %H:%M') }}</small>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p>No recent activity. Start by taking a test!</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Test Performance -->
    <div class="card mb-4">
    <div class="card-header">Test Performance</div>
    <div class="card-body">
        {% if tests %}
            <canvas id="testChart" height="300" aria-label="Test performance chart" role="img"></canvas>
            <noscript>
                <p>Test Scores:</p>
                <ul>
                    {% for test in tests %}
                        <li>{{ test.test_type | capitalize }}: {{ test.score|round(2) }}% on {{ test.completed_at.strftime('%Y-%m-%d') }}</li>
                    {% endfor %}
                </ul>
            </noscript>
        {% else %}
            <p class="text-muted">No test data available to display.</p>
        {% endif %}
    </div>
</div>

    <!-- Progress Stats -->
    <div class="card">
        <div class="card-header">Progress Statistics</div>
        <div class="card-body">
            <div class="mb-3">
                <p class="mb-1">Average Score:</p>
                {% set avg_score = (tests|map(attribute='score')|sum / tests|length) if tests|length > 0 else 0 %}
                <div class="progress" role="progressbar" aria-valuenow="{{ avg_score|round|int }}" aria-valuemin="0" aria-valuemax="100">
                    <div class="progress-bar" style="width: {{ avg_score|round|int }}%">
                        {{ avg_score|round(1) }}%
                    </div>
                </div>
            </div>
            <div class="mb-3">
                <p>Total Tests Taken: {{ tests|length }}</p>
            </div>
            <div class="alert alert-info">
                {{ 'Complete more tests for better career insights!' if tests|length < 3 else 'Proceed to career matching for personalized results!' }}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Personalized Greeting
    function setGreeting() {
        const hour = new Date().getHours();
        let greetingText = "Welcome";
        if (hour >= 5 && hour < 12) greetingText = "Good Morning";
        else if (hour >= 12 && hour < 17) greetingText = "Good Afternoon";
        else if (hour >= 17 && hour < 22) greetingText = "Good Evening";
        else greetingText = "Good Night";
        document.getElementById('greeting').textContent = `${greetingText}, {{ user.username }}!`;
    }
    setGreeting();

    // Initialize Chart if tests exist
    {% if tests %}
    document.addEventListener('DOMContentLoaded', function() {
        try {
            if (typeof Chart !== 'undefined') {
                const ctx = document.getElementById('testChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: {{ tests | map(attribute='completed_at') | map('strftime', '%Y-%m-%d') | list | tojson }},
                        datasets: [{
                            label: 'Test Scores (%)',
                            data: {{ test_scores | tojson }},
                            borderColor: '#ff6f61',
                            backgroundColor: 'rgba(255, 111, 97, 0.1)',
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, max: 100 }
                        }
                    }
                });
            }
        } catch (e) {
            console.error('Chart initialization failed:', e);
        }
    });
    {% endif %}

    // Notification Mark as Read
    document.querySelectorAll('.mark-read').forEach(button => {
        button.addEventListener('click', function() {
            const notificationId = this.getAttribute('data-id');
            const notificationItem = this.closest('[data-notification-id]');
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
            this.disabled = true;
            fetch(`/mark_notification_read/${notificationId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': '{{ csrf_token() }}'
                }
            })
            .then(response => {
                if (response.ok) {
                    notificationItem.remove();
                    const badge = document.querySelector('.notification-badge');
                    if (badge) {
                        const count = parseInt(badge.textContent);
                        if (count > 1) badge.textContent = count - 1;
                        else badge.remove();
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                this.innerHTML = 'Mark as Read';
                this.disabled = false;
            });
        });
    });
</script>
{% endblock %}