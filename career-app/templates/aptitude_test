<script>
document.addEventListener('DOMContentLoaded', () => {
    const timerElement = document.getElementById('time-left');
    const answeredCountElement = document.getElementById('answered-count');
    const progressBar = document.getElementById('progress-bar');
    const form = document.getElementById('aptitude-form');
    const timeSpentInput = document.getElementById('time-spent');
    let timeLeft = {{ initial_time|default(60) }};
    let answeredCount = {{ completed_questions|default(0) }};
    const totalQuestions = {{ total_questions|default(0) }};

    if (totalQuestions > 0 && timerElement && answeredCountElement && progressBar && form) {
        const timerInterval = setInterval(() => {
            timeLeft--;
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                form.submit();
            }
        }, 1000);

        document.querySelectorAll('.form-check-input').forEach(input => {
            input.addEventListener('change', function() {
                const questionId = this.name;
                const alreadyAnswered = document.querySelectorAll(`input[name="${questionId}"]:checked`).length > 1;
                if (!alreadyAnswered) {
                    answeredCount++;
                    answeredCountElement.textContent = answeredCount;
                    progressBar.style.width = `${(answeredCount / totalQuestions) * 100}%`;
                }
            });
        });

        let currentCategoryIndex = 0;
        const categories = Array.from(document.querySelectorAll('.category-section'));
        
        document.querySelector('.next-category').addEventListener('click', () => {
            if (currentCategoryIndex < categories.length - 1) {
                categories[currentCategoryIndex].classList.add('d-none');
                currentCategoryIndex++;
                categories[currentCategoryIndex].classList.remove('d-none');
                document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector(`.category-btn[data-category="${categories[currentCategoryIndex].id.replace('category-', '').replace('-', ' ')}"]`).classList.add('active');
            }
        });
        
        document.querySelector('.prev-category').addEventListener('click', () => {
            if (currentCategoryIndex > 0) {
                categories[currentCategoryIndex].classList.add('d-none');
                currentCategoryIndex--;
                categories[currentCategoryIndex].classList.remove('d-none');
                document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector(`.category-btn[data-category="${categories[currentCategoryIndex].id.replace('category-', '').replace('-', ' ')}"]`).classList.add('active');
            }
        });

        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const newCategory = btn.getAttribute('data-category').replace('-', ' ');
                const newIndex = categories.findIndex(cat => cat.id === `category-${newCategory.replace(' ', '-')}`);
                if (newIndex !== -1 && newIndex !== currentCategoryIndex) {
                    categories[currentCategoryIndex].classList.add('d-none');
                    currentCategoryIndex = newIndex;
                    categories[currentCategoryIndex].classList.remove('d-none');
                    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                }
            });
        });

        form.addEventListener('submit', (e) => {
            timeSpentInput.value = {{ initial_time|default(60) }} - timeLeft;
        });
    }
});
</script>